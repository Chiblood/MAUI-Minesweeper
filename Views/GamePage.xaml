<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MAUI_Minesweeper.Views.GamePage"
             xmlns:models="clr-namespace:MAUI_Minesweeper.Models"
             xmlns:viewmodels="clr-namespace:MAUI_Minesweeper.ViewModels"
             x:DataType="viewmodels:GameViewModel"
             Title="GamePage">
    <Grid RowDefinitions="Auto,*,Auto" Padding="10">

        <!-- Header Section: Game Stats -->
        <Grid Grid.Row="0" 
              ColumnDefinitions="*,*,*" 
              Padding="10"
              ColumnSpacing="10">

            <!-- Flags Remaining -->
            <Border Grid.Column="0" 
                    Padding="10" 
                    BackgroundColor="#E3F2FD"
                    Stroke="#2196F3"
                    StrokeThickness="2"
                    StrokeShape="RoundRectangle8">
                <VerticalStackLayout Spacing="5">
                    <Label Text="ğŸš© Flags" 
                           FontSize="14"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           TextColor="Black"/>
                    <Label Text="{Binding FlagsRemaining}" 
                           FontSize="20"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           TextColor="Black"/>
                </VerticalStackLayout>
            </Border>

            <!-- Game Status -->
            <Border Grid.Column="1" 
                    Padding="10" 
                    BackgroundColor="#FFF3E0"
                    Stroke="#FF9800"
                    StrokeThickness="2"
                    StrokeShape="RoundRectangle8">
                <VerticalStackLayout Spacing="5">
                    <Label Text="Status" 
                           FontSize="14"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           TextColor="Black"/>

                    <Label Text="{Binding GameStatus}" 
                           FontSize="20"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           TextColor="Black"/>
                    
                </VerticalStackLayout>
            </Border>

            <!-- Timer -->
            <Border Grid.Column="2" 
                    Padding="10" 
                    BackgroundColor="#E8F5E9"
                    Stroke="#4CAF50"
                    StrokeThickness="2"
                    StrokeShape="RoundRectangle8">
                <VerticalStackLayout Spacing="5">
                    <Label Text="â±ï¸ Time" 
                           FontSize="14"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           TextColor="Black"/>
                    <Label Text="{Binding ElapsedTime}" 
                           FontSize="20"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           TextColor="Black"/>
                </VerticalStackLayout>
            </Border>
        </Grid>
        
        <!-- Game Board: CollectionView with Grid Layout -->
        <ScrollView Grid.Row="1" 
            HorizontalScrollBarVisibility="Always"
            VerticalScrollBarVisibility="Always">
            <CollectionView ItemsSource="{Binding Cells}"
                    SelectionMode="None"
                    HorizontalOptions="Center"
                    VerticalOptions="Center">

                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Horizontal" 
                             Span="{Binding Cols}"
                             HorizontalItemSpacing="0"
                             VerticalItemSpacing="0"/>
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="{x:Null}">
                        <Border Padding="0"
                            Stroke="#999"
                            StrokeThickness="1"
                            StrokeShape="RoundRectangle4"
                            WidthRequest="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.CellSize}"
                            HeightRequest="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.CellSize}">  
                            
                            <!-- Cell Button with Gestures -->
                            <Grid BackgroundColor="{Binding IsRevealed, Converter={StaticResource CellBackgroundConverter}}">
                                <Grid.GestureRecognizers>
                                    <!-- Separate recognizers for left and right clicks -->
                                    <TapGestureRecognizer 
                                        Tapped="OnCellLeftClicked"
                                        Buttons="Primary" />
                                    <TapGestureRecognizer 
                                        Tapped="OnCellRightClicked"
                                        Buttons="Secondary" />
                                </Grid.GestureRecognizers>
                                
                                <!-- Cell Content -->
                                <Label Text="{Binding DisplayText}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"
                                   TextColor="{Binding NeighboringMines, Converter={StaticResource MineCountColorConverter}}"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </ScrollView>
        
        <!-- Footer Section: Controls -->
        <Grid Grid.Row="2" 
          ColumnDefinitions="*,Auto" 
          Padding="10"
          ColumnSpacing="10">

            <!-- Difficulty Picker -->
            <Picker Grid.Column="0"
                Title="Difficulty"
                SelectedIndexChanged="OnDifficultyChanged"
                BackgroundColor="#F5F5F5"
                    TextColor="Black">
                <Picker.ItemsSource>
                    <x:Array Type="{x:Type x:String}">
                        <x:String>Easy (8x8)</x:String>
                        <x:String>Medium (16x16)</x:String>
                        <x:String>Hard (16x30)</x:String>
                    </x:Array>
                </Picker.ItemsSource>
            </Picker>

            <!-- New Game Button -->
            <Button Grid.Column="1"
                Text="ğŸ”„ New Game"
                Command="{Binding NewGameCommand}"
                BackgroundColor="#2196F3"
                TextColor="White"
                CornerRadius="8"
                Padding="20,10"/>
        </Grid>
    </Grid>
</ContentPage>